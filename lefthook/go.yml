pre-commit:
  commands:
    mod-tidy:
      glob: "**/*.go"
      run: go mod tidy && git diff --exit-code go.mod go.sum
      fail_text: "go mod tidy made changes"

    fmt:
      glob: "**/*.go"
      run: gofmt -l {staged_files} && test -z "$(gofmt -l {staged_files})"
      fail_text: "gofmt found unformatted files"

    vet:
      glob: "**/*.go"
      run: go vet ./...
      fail_text: "go vet found issues"

    lint:
      glob: "**/*.go"
      run: (test -f custom-gcl || golangci-lint custom) && ./custom-gcl run --new-from-rev=HEAD
      fail_text: "golangci-lint found issues"

    errcheck:
      glob: "**/*.go"
      run: errcheck -blank -exclude .errcheck_excludes.txt ./...
      fail_text: "errcheck found unchecked errors"

    cyclomatic:
      glob: "**/*.go"
      run: gocyclo -over 10 {staged_files}
      fail_text: "cyclomatic complexity > 10"

    cognitive:
      glob: "**/*.go"
      run: gocognit -over 15 {staged_files}
      fail_text: "cognitive complexity > 15"

    file-size:
      glob: "**/*.go"
      shell: bash
      run: |
        MAX_LINES=300
        for f in {staged_files}; do
          if [[ ! "$f" =~ _test\.go$ ]] && [[ ! "$f" =~ mock_ ]]; then
            lines=$(wc -l < "$f")
            if [ "$lines" -gt "$MAX_LINES" ]; then
              echo "$f: $lines lines (limit: $MAX_LINES)"
              exit 1
            fi
          fi
        done
      fail_text: "source files must be â‰¤300 lines (tests and mocks excluded)"

    security:
      glob: "**/*.go"
      run: gosec -quiet ./...
      fail_text: "gosec found security issues"

    test:
      glob: "**/*.go"
      run: go test -short ./...
      fail_text: "tests failed"

pre-push:
  commands:
    full-lint:
      run: (test -f custom-gcl || golangci-lint custom) && ./custom-gcl run ./...
      fail_text: "full lint failed"

    coverage:
      shell: bash
      run: |
        trap 'rm -f coverage.txt' EXIT
        go test -race -short -coverprofile=coverage.txt -covermode=atomic ./...
        COVERAGE=$(go tool cover -func=coverage.txt | grep '^total:' | awk '{print $3}' | tr -d '%')
        THRESHOLD=50
        if awk -v c="$COVERAGE" -v t="$THRESHOLD" 'BEGIN {exit !(c < t)}'; then
          echo "Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
          exit 1
        fi
        echo "Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"
      fail_text: "coverage below 50% threshold"

    vulncheck:
      run: govulncheck ./...
      fail_text: "known vulnerabilities found"
