pre-commit:
  parallel: true
  commands:
    trailing-whitespace:
      glob: "*.{go,yaml,yml,md,json}"
      run: |
        if grep -Hn '[[:blank:]]$' {staged_files} 2>/dev/null; then
          echo "Trailing whitespace found"
          exit 1
        fi
      fail_text: "trailing whitespace found"

    end-of-file:
      glob: "*.{go,yaml,yml,md,json}"
      run: |
        for f in {staged_files}; do
          if [ -s "$f" ] && [ -n "$(tail -c 1 "$f")" ]; then
            echo "$f: no newline at end of file"
            exit 1
          fi
        done
      fail_text: "files must end with newline"

    check-yaml:
      glob: "*.{yaml,yml}"
      run: |
        for f in {staged_files}; do
          python3 -c "import yaml; yaml.safe_load(open('$f'))" 2>/dev/null || \
          yq e '.' "$f" > /dev/null
        done
      fail_text: "invalid YAML syntax"

    check-large-files:
      run: |
        MAX_KB=500
        for f in {staged_files}; do
          size=$(wc -c < "$f" 2>/dev/null || echo 0)
          if [ "$size" -gt $((MAX_KB * 1024)) ]; then
            echo "$f exceeds ${MAX_KB}KB"
            exit 1
          fi
        done
      fail_text: "file exceeds 500KB limit"

    check-merge-conflict:
      run: |
        if grep -Hn '^<<<<<<< \|^=======$\|^>>>>>>> ' {staged_files} 2>/dev/null; then
          echo "Merge conflict markers found"
          exit 1
        fi
      fail_text: "merge conflict markers found"

    mod-tidy:
      glob: "*.go"
      run: go mod tidy && git diff --exit-code go.mod go.sum
      fail_text: "go mod tidy made changes"

    fmt:
      glob: "*.go"
      run: gofmt -l {staged_files} && test -z "$(gofmt -l {staged_files})"
      fail_text: "gofmt found unformatted files"

    vet:
      glob: "*.go"
      run: go vet ./...
      fail_text: "go vet found issues"

    lint:
      glob: "*.go"
      run: golangci-lint run --new-from-rev=HEAD
      fail_text: "golangci-lint found issues"

    test:
      glob: "*.go"
      run: go test -short ./...
      fail_text: "tests failed"

pre-push:
  commands:
    full-lint:
      run: golangci-lint run ./...
      fail_text: "full lint failed"

    vulncheck:
      run: govulncheck ./...
      fail_text: "known vulnerabilities found"
